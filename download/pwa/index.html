<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>大老爺</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="大老爺">

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/180.png">

  ...
</head>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/180.png">

  <style>
    body {
      background:#000;
      color:#fff;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro", system-ui;
      text-align:center;
    }
    .btn {
      background:#0a84ff;
      padding:12px 24px;
      border-radius:12px;
      color:#fff;
      font-size:18px;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
  </style>
</head>

<body>

  <div>
    <h2>大老爺</h2>
    <p>即將為您啟動應用</p>
    <button class="btn" id="go">立即前往</button>
  </div>

 <script>
  const TARGET_URL = "https://ag223.gm89.net/login?id=register";

  // 1. 註冊 Service Worker（iOS / Android 都需要）
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(console.error);
  }

  // 2. 判斷是否是「已安裝的 APP 模式」（從主畫面打開）
  const isStandalone =
    window.matchMedia("(display-mode: standalone)").matches ||
    window.navigator.standalone === true;

  // 3. Android 安裝事件暫存
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    console.log("beforeinstallprompt 觸發");
    e.preventDefault();
    deferredPrompt = e;

    const info = document.getElementById("info");
    if (info) {
      info.textContent = "此裝置支援安裝到主畫面，點擊下方按鈕即可安裝。";
    }
  });

  if (isStandalone) {
    // ✅ 已安裝（從主畫面開啟）→ 直接換成官網，不留上一頁紀錄
    location.replace(TARGET_URL);
  } else {
    // ✅ 尚未安裝：處理按鈕行為
    const btn = document.getElementById("go");
    if (btn) {
      btn.addEventListener("click", async () => {
        // 若是 Android 且有安裝事件
        if (deferredPrompt) {
          deferredPrompt.prompt();
          try {
            const choiceResult = await deferredPrompt.userChoice;
            console.log("userChoice:", choiceResult.outcome);

            if (choiceResult.outcome === "accepted") {
              // 使用者真的按了「安裝」
              alert("已送出安裝，請回到手機主畫面，找到「大老爺」圖示開啟。\n\n之後再從圖示進入就會直接開啟遊戲頁面。");
              // 不立刻跳轉官網，讓他自己先回桌面看
              return;
            }
          } catch (err) {
            console.error(err);
          }
          deferredPrompt = null;
        }

        // 沒有安裝事件（或使用者拒絕安裝）→ 直接幫你開官網
        window.location.href = TARGET_URL;
      });
    }

    // iOS：給安裝教學
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isIOS) {
      alert(
        "iPhone 安裝步驟：\n\n1. 請點下方中間的【分享】按鈕（方框上箭頭）\n" +
        "2. 往下滑選「加入主畫面」\n" +
        "3. 回到主畫面點『大老爺』圖示啟動 APP"
      );
    }
  }
</script>

</body>
</html>
